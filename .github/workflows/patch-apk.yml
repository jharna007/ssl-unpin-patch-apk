name: Patch APK using apk-mitm

on:
  workflow_dispatch:

jobs:
  patch-apk:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install apk-mitm
      run: npm install -g apk-mitm

    - name: Download APK from Google Drive
      run: |
        FILEID="1kLSGL_aobogGnvoQ-Ey4OBdSHP7if9JI"
        FILENAME="base.apk"

        curl -c /tmp/cookies.txt -s -L "https://drive.google.com/uc?export=download&id=${FILEID}" > /tmp/intermediate.html

        CONFIRM=$(grep -oP 'confirm=\K[^&]+' /tmp/intermediate.html | head -n 1)

        curl -Lb /tmp/cookies.txt "https://drive.google.com/uc?export=download&confirm=${CONFIRM}&id=${FILEID}" -o ${FILENAME}

        file ${FILENAME}
        unzip -t ${FILENAME} || echo "⚠️ Warning: APK might be corrupt"

    - name: Patch APK
      run: apk-mitm base.apk patched-base.apk

    - name: Upload patched APK
      uses: actions/upload-artifact@v4
      with:
        name: patched-base-apk
        path: patched-base.apk
