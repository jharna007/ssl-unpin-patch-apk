name: Patch APK with apk-mitm

on:
  workflow_dispatch:

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install apk-mitm
        run: npm install -g apk-mitm

      - name: Download APK from Google Drive
        run: |
          FILEID="1kLSGL_aobogGnvoQ-Ey4OBdSHP7if9JI"
          FILENAME="base.apk"

          CONFIRM=$(curl -sc /tmp/gcookie "https://drive.google.com/uc?export=download&id=${FILEID}" | \
                    grep -o 'confirm=[^&]*' | sed 's/confirm=//')

          curl -Lb /tmp/gcookie "https://drive.google.com/uc?export=download&confirm=${CONFIRM}&id=${FILEID}" -o "${FILENAME}"

      - name: Patch APK with apk-mitm
        run: apk-mitm base.apk patched-base.apk

      - name: Upload patched APK
        uses: actions/upload-artifact@v4
        with:
          name: patched-apk
          path: patched-base.apk
